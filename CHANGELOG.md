# Changelog

All notable changes to IsoCitySim will be documented in this file.

## [Unreleased]

### Changed
- **Sandbox Mode Now Starts Blank** - True "blank canvas" experience for gameplay
  - Procedural lot extraction only runs in Procedural mode
  - Building spawning only runs in Procedural mode
  - River generation only runs in Procedural mode
  - Player uses zone painting tools to develop the city from scratch
- **Procedural Mode Unchanged** - Still auto-generates roads, river, and buildings for testing

### Fixed
- Fixed repeating spawn logs in Sandbox mode - Added "spawned" marker resources to:
  - StreetTreesPlugin, ParkedCarsPlugin, CrosswalksPlugin
  - TrafficLightsPlugin, StreetLampsPlugin, RoadMarkingsPlugin
  - StreetFurniturePlugin (hydrants, benches, trash cans)
- Systems now run once instead of every frame when no entities are created

### Added
- **City Simulation Mode** - Transform from generator to full city builder
  - Game state machine with MainMenu, Playing states
  - Sandbox mode (blank canvas) and Procedural mode (generated roads)
  - Start menu with mode selection and terrain presets
- **Zone Paint Tool** - Click-drag to paint RCI zones
  - Residential (green), Commercial (blue), Industrial (yellow)
  - Visual zone overlays on terrain
  - Keyboard shortcuts: R/C/I for zone types
- **Road Drawing Tool** - Click to place road nodes and edges
  - Auto-connects to previous node
  - Snaps to existing nodes within 15 units
  - Dynamic road mesh regeneration
  - Keyboard shortcut: D
- **Demolish Tool** - Remove buildings and zones
  - Click or drag to select demolition area
  - Costs deducted from city budget
  - Keyboard shortcut: X
- **Service Buildings** - Place city services
  - Police Station - Reduces crime in radius
  - Fire Station - Provides fire coverage
  - Hospital - Provides healthcare, affects population growth
  - School - Provides education
  - Park - Increases happiness and land value
  - Each service has cost and coverage radius
- **RCI Demand System** - SimCity-style zone demand
  - Calculates Residential/Commercial/Industrial demand (-1.0 to 1.0)
  - Based on population vs housing, jobs vs workers, zone balance
  - Displayed in stats bar with visual meters
- **Building Growth System** - Zones develop into buildings
  - Growth probability based on demand and land value
  - Building height scales with land value
  - Taller, nicer buildings in high-value areas
- **Population Tracking** - Dynamic population simulation
  - Growth based on housing capacity, employment, finances
  - Affected by service coverage (health, parks)
  - Affected by commute quality and crime levels
- **City Economy** - Budget and tax system
  - Starting funds, tax income from buildings
  - Road maintenance costs
  - Service building costs
- **Land Value System** - Comprehensive location scoring
  - Pollution (from industrial buildings)
  - Crime rate (reduced by police)
  - Education access (from schools)
  - Healthcare access (from hospitals)
  - Park access (from parks)
  - Commute factor (distance to jobs)
  - Composite land value affects growth
- **Service Coverage Effects** - City-wide service statistics
  - Police/Fire/Healthcare/Education coverage percentages
  - Crime modifier, fire risk, health/education modifiers
  - Happiness modifier from parks
- **Commute & Traffic Simulation** - Basic traffic modeling
  - Average/max commute distance calculation
  - Job accessibility score
  - Traffic congestion based on buildings vs road capacity
- **Toolbox UI** - Left sidebar with tool buttons
  - Zones section (R/C/I)
  - Roads section
  - Services section (Po/Fi/Ho/Sc/Pk)
  - Actions section (Demolish, Query)
- **Stats Bar UI** - Top bar showing city statistics
  - Population count with formatted numbers
  - City funds
  - RCI demand meters with color-coded bars
- **River & Water System** - Procedural river cutting through the city
  - Meandering river generation with cubic Bezier curves
  - Custom water shader with animated waves, reflections, and foam
  - Automatic bridge spawning at river crossings (26 bridges)
  - Road network avoids water except at bridge points
- **Bridge Rendering** - Realistic bridge deck meshes over water
  - Proper road width matching for Highway/Major/Minor types
  - Elevated decks with terrain-following approaches
- **Facade-Aware Windows** - Building windows vary by architectural style
  - Glass facades: Large floor-to-ceiling panels (2.4m×2.6m), blue-tinted, highly reflective
  - Brick facades: Small traditional windows (1.0m×1.4m) with white frames
  - Concrete facades: Medium windows (1.5m×1.8m), minimal grey frames
  - Metal/Industrial: Large sparse openings (2.0m×2.2m), steel frames
  - Painted facades: Traditional windows (1.1m×1.5m) with white frames
  - Different occupancy rates and night intensities per style
  - 1,692 window frames spawned for traditional styles
- **Rooftop Details** - Procedural rooftop equipment and structures
  - AC units on commercial/industrial buildings (60% probability)
  - Water towers on traditional residential (Brick/Painted facades)
  - Communication antennas on various buildings (20% probability)
  - Helipads on tall commercial buildings (>20m)
  - Grey metal materials for industrial look
  - ~460 rooftop elements spawned
- **Tilt-Shift Effect** - Post-processing effect for miniature/diorama look
  - Custom WGSL shader (`assets/shaders/tilt_shift.wgsl`)
  - Configurable focus center, width, blur amount, and saturation
  - Gaussian blur increases toward screen edges, sharp focus band in center
  - Saturation boost for enhanced miniature aesthetic
  - Toggle via `TiltShiftConfig.enabled`
- **Pedestrians** - Walking pedestrians on sidewalks
  - 50 pedestrians spawned at road nodes, walking at ~1.4 m/s
  - Sidewalk offset calculation using perpendicular road direction
  - Varied clothing colors (8 options) and skin tones (5 options)
  - Random wandering between intersections on Major/Minor roads
- **Moving Vehicles** - Cars driving on the road network
  - 25 vehicles traversing road edges with waypoint-based navigation
  - Speed varies by road type (Highway 1.5x, Major 1.0x, Minor 0.8x)
  - Traffic light awareness - vehicles stop at red/yellow lights
  - Random edge selection at intersections
- **Street Trees** - Trees lining sidewalks on Major and Minor roads
  - 25m spacing, alternating sides of street
  - Varied heights (5-10m) and foliage sizes (2-3.5m)
  - Three foliage color variations
  - Terrain-following placement
- **Mouse Panning** - Camera pan with middle/right mouse button drag
- **Cloud Shadows** - Drifting cloud shadows using procedural 5-octave FBM noise
  - Custom WGSL shader (`assets/shaders/cloud_shadows.wgsl`)
  - Configurable wind direction, speed, coverage, and opacity
  - Automatically fades out at night
- **Building Drop Shadows** - Alpha-blended shadow planes beneath buildings
  - Shadow offset based on building height (simulates sun angle)
  - Configurable opacity and spread
- **Weather System** - Dynamic weather with fog, rain, and wet surfaces
  - Four weather states: Clear, Foggy, Rainy, Stormy
  - Weather-modulated fog density (1x to 3x multiplier on base day/night fog)
  - Fog color tinting per weather state
  - Custom rain shader (`assets/shaders/rain.wgsl`) with procedural falling raindrops
  - Multi-layer rain with wind angle effects during storms
  - Wet surface overlay (`assets/shaders/wet_surface.wgsl`) with puddles and reflections
  - Rain ripple animation in puddles during active rain
  - Smooth 10-second transitions between weather states
  - Automatic weather cycling (random changes every 10-30 minutes)
  - Cloud shadow integration (coverage increases during storms)
  - Keyboard controls: F (cycle), F5-F8 (direct), Shift+F (toggle auto-cycle)
- **GPU-Driven Rendering Pipeline** - High-performance rendering infrastructure
  - **GPU Instancing** (`src/render/instancing.rs`) - Hardware instanced rendering for city geometry
    - Extended InstanceData struct (112 bytes) with full 4x4 transform matrix
    - Material parameters (roughness, metallic, emissive, facade_type)
    - Bounding info for culling integration
  - **Mesh Pools** (`src/render/mesh_pools.rs`) - Shared mesh pool for building variants
    - Box, L-Shape, Tower-on-Base, and Stepped building meshes
    - Reduces mesh duplication across thousands of buildings
  - **Building Instance Buffer** (`src/render/building_instances.rs`) - Centralized instance management
    - BuildingInstanceData resource for batched rendering
    - Automatic buffer resizing and dirty tracking
  - **Clustered Shading** (`src/render/clustered_shading/`) - Efficient many-light rendering
    - 16x9x24 cluster grid with exponential depth slicing (3,456 clusters)
    - Supports 5,000+ dynamic point lights at 60 FPS
    - Light-to-cluster assignment for O(1) fragment light lookup
    - Custom WGSL shaders (`cluster_assign.wgsl`, `cluster_lighting.wgsl`)
  - **Window Instancing** (`src/render/window_instances.rs`) - Batched window rendering
    - WindowInstanceData struct with position, size, normal, color, intensity
    - Facade-aware window properties (size, occupancy, night intensity)
    - Custom window shader (`assets/shaders/window_instanced.wgsl`)
  - **Facade Texture Arrays** (`src/render/facade_textures.rs`) - Procedural texture generation
    - 5-layer texture array (Brick, Concrete, Glass, Metal, Painted)
    - 256x256 procedural textures with varied patterns
    - Single-draw-call material switching via facade_type index
- **GPU Frustum Culling** (`src/render/gpu_culling/`) - Compute shader object culling
  - ObjectData buffer with bounding spheres (32 bytes per object)
  - FrustumPlanes extraction using Gribb-Hartmann method
  - 6-plane sphere-frustum intersection testing
  - WGSL compute shader (`assets/shaders/frustum_cull.wgsl`) with 64-thread workgroups
  - CPU fallback culling when compute shaders unavailable
  - GpuCullable component for per-entity culling participation
  - Real-time culling statistics (visible/culled ratio)
- **HZB Occlusion Culling** (`src/render/hzb/`) - Hierarchical depth buffer infrastructure
  - HzbPyramid resource for depth mip chain management
  - CpuHzbPyramid for software fallback occlusion testing
  - MAX reduction depth pyramid generation (`assets/shaders/hzb_generate.wgsl`)
  - Screen-space projection utilities for bounding sphere size calculation
  - Appropriate mip level selection based on projected object size
  - Previous-frame depth usage for render dependency avoidance
  - Integration with frustum culling shader (`main_with_hzb` entry point)
- **GPU Indirect Draw Integration** (`src/render/gpu_culling/pipeline.rs`) - Fully GPU-driven rendering
  - GpuCullingPipeline with compute shader binding
  - GpuCullingBuffers for uniforms, frustum, objects, visibility, and indirect commands
  - DrawIndexedIndirect buffer populated by culling compute shader
  - Render graph node (GpuCullingNode) for compute pass execution
  - ExtractedCullData for main-to-render world data transfer
  - Zero CPU involvement in visibility determination
  - `main_indirect` shader entry point for indirect draw command generation

### Fixed
- **Terrain-following for all objects** - All city elements now properly follow terrain height:
  - Roads, sidewalks, and intersections
  - Road markings (lane lines)
  - Crosswalks
  - Parked cars (body and wheels)
  - Buildings (all shapes: box, L-shape, tower, stepped)
  - Parks and trees
  - Building drop shadows
- Fixed `ResMut`/`Res` resource conflict in `window_lights.rs`

### Changed
- Road mesh generation now samples terrain height at each vertex
- Building spawner samples terrain at building center for proper placement

## [0.1.0] - Initial Release

### Added
- Procedural city generation using tensor field road network
- Day/night cycle with directional sun lighting
- Cascaded shadow maps (3 cascades, 2048x2048)
- Window lights that glow at night with color variety
- Terrain height variation using Perlin noise
- Multiple building shapes (Box, L-Shape, Tower on Base, Stepped)
- Street furniture (lamps, traffic lights, fire hydrants, benches)
- Parked cars with varied colors
- Crosswalks at intersections
- Road markings (center lines, edge lines)
- Parks with procedural trees
